<!DOCTYPE html>
<html>
<head>
	<title>History Graph</title>
	<link rel="stylesheet" type="text/css" href="lib/info.css">
	<style type="text/css">
		#info {
			background-color: darkgrey;
			color: white;
			font-family: sans-serif;
			padding-left: 10px;
		}
		
	textarea {
		padding: 10px;
		max-width: 100%;
		line-height: 1.5;
		border-radius: 5px;
		border: 1px solid #ccc;
		box-shadow: 1px 1px 1px #999;
	}

	label {
		display: block;
		margin-bottom: 10px;
	}

	</style>
	<script src="lib/menu.js"></script>
	<script type="text/javascript">

		var data = null;
		
		function inspectPage() {
			require('nw.gui').Window.get().showDevTools()
		}

		function inspectBgPage() {
			chrome.developerPrivate.openDevTools({
			    renderViewId: -1,
			    renderProcessId: -1,
			    extensionId: chrome.runtime.id
			})
		}
		
		function button_remove_keyword(kw){
			console.log("The function is called :D");
			console.log(kw)
			const index = data.cluster.indexOf(kw)
			data.cluster = data.cluster.splice(index,1)
			
			//Delete the HTML
			document.getElementById("line_"+kw).remove();
		}
		
		function createKeywordEntry(kw){
			if (data.cluster.includes(kw) == false){
				data.cluster.push(kw)
		}
			
			console.log("Adding the keyword: "+kw)
			var word_cluster = document.getElementById('cluster_tab');
			var tr = "<tr id=\"line_"+kw+"\">";
			//var button_html = "<button onclick=\"button_remove_keyword(\""+kw+"\")\">Remove</button>";
			var button_html = "<button onclick=\"button_remove_keyword(&quot;"+ kw + "&quot;)\"> Remove </button>";
			console.log("HTML code of the button");
			console.log(button_html);
			tr += "<td>" + kw + "</td>" +"<td>" + button_html + "</td>"
			tr +="</tr>"
			word_cluster.innerHTML += tr;
		}

		function init() {
		
			//Displaying all the properties of our nodes
			var tbody = document.getElementById('tbody');
			
			window.addEventListener('message', function(event) {
			console.log("Received the node from "+ event.origin)
			data = JSON.parse(event.data);
			
			// Maybe better performance with another method but couldn't make it work
			//https://stackoverflow.com/questions/17684201/create-html-table-from-javascript-object
			var lim = Object.keys(data).length;
			
			for (var i = 0; i < lim; i++) {
				var key = Object.keys(data)[i];
				var value = Object.values(data)[i];
				
				if (key == 'cluster') {
					value.forEach(element=>{console.log('init with ' + element);createKeywordEntry(element)});
				} else {
					var tr = "<tr>";
					tr += "<td>" + key + "</td>";
					tr += "<td>" + value + "</td>"
					tr += "</tr>";
				tbody.innerHTML += tr;
				}
			
			}
			console.log("Tab displayed! Now adding auto scaling");
			//Credit to this post for text area with auto resize
			//https://stackoverflow.com/questions/454202/creating-a-textarea-with-auto-resize
			
			const tx = document.getElementsByTagName("textarea");
			for (let i = 0; i < tx.length; i++) {
			  tx[i].setAttribute("style", "height:" + (tx[i].scrollHeight) + "px;overflow-y:hidden;");
			  tx[i].addEventListener("input", OnInput, false);
			}

			function OnInput() {
			  this.style.height = "auto";
			  this.style.height = (this.scrollHeight) + "px";
			}
		},false);
			
			window.addEventListener("beforeunload", function(){
				opener.postMessage(JSON.stringify(data))
			});
	
	}
	</script>
</head>
<body onload="init()">
	<div id="wrapper">
		<div>	
			<h1> Node info </h1>
		</div>
		
		<div id ="node_prop">
			<h2> Nodes properties </h2>
			<table>
		    		<tbody id="tbody"></tbody>
			</table>
		</div>
		
		<div id="word_cluster">
		<script>
			function button_add_new_keyword(){
				var kw = document.getElementById("add_keyword").value;
				if (kw == ""){
					alert("Please do not insert blank keyword")
				} else if (data.cluster.includes(kw) == true) {
					alert("Keyword already exists")
				} else {
					createKeywordEntry(kw);
					alert("Keyword inserted");
				}
			}
		</script>
			<h2> Word cluster </h2>
			<label for="add_keyword">Add a keyword:</label>
			<textarea id="add_keyword"></textarea>
			<button onclick="button_add_new_keyword()">Add</button>
			<table>
				<tbody id="cluster_tab"></tbody>
			</table>
		</div>
	</div>
</body>
</html>
